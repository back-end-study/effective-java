# Item 48. 스트림 병렬화는 주의해서 적용하라

병렬 스트림 ?
- 각각의 스레드에서 처리할수있도록 스트림요소를 청크로 분할한 스트림,
멀티코어 프로세서가 각각의 청크를 처리하도록 할당할수있다.

- 스트림에 parallel을 호출해도 스트림자체에는 변화가 일어나지않으며 내부적으로 이후 연산이 병렬로 수행해야함을 의미하는 boolean 플래그가 설정된다

### 병렬화 불가능한 스트림 연산들이 존재한다
```java
public class StreamTest {
    static Stream<BigInteger> primes() {
        return Stream.iterate(TWO, BigInteger::nextProbablePrime);
    }

    public static void main(String[] args) {
        primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
                .filter(mersenne -> mersenne.isProbablePrime(50))
                .limit(20)
                .forEach(System.out::println);
    }
}
```

속도를 높이고 싶어 스트림 parallel()을 호출하려고 한다면 아무것도 출력하지못하고(응답불가) CPU만 잡아먹는 상황이 무한히 반복된다
=> 스트림이 limit, Stream.iterate같은 파이프라인에대해 병렬화하는방법을 찾아내지 못했기 때문이다.

#### 병렬화로 인해 오히려 성능이 나빠질수도 있다
CPU코어가 남는상황에서 limit을 병렬화한다면 쿼드코어라고 가정하고 마지막 20번째 계산이 수행되는시점에 코어3개가 놀게되는데 이때 21,22,23번째 메르센 소수를 찾는작업이 병렬로 시작되어 20번째 계산보다 2,4,8배의 시간이 더 필요해서 
20번째 작업이 끝나도 계산이 끝나지않는다.

#### 스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap의 인스턴스이거나 배열,int 범위, long범위 일때 병렬화의 효과가 가장좋다

  - 데이터를 원하는 크기로 정확하고 손쉽게 나눌수있어 다수의 스레드를 분배하기에 좋기때문

  - 순차적으로 실행할때의 참조 지역성이 뛰어나다(메모리에 연속 저장되어있다)
  - 참조 지역성이 낮으면 데이터가 주 메모리에서 캐시메모리로 전송되어 오기를 기다리게된다. 
  - 배열같은경우 **데이터자체가 메모리에 연속저장**되어 참조지역성이 가장 뛰어나다.

### 종단연산

- reduce , anyMatch,allMatch 등의 조건이 맞으면 바로반환되는 메서드는 병렬화에 적합하다 

- 가변축소(mutable reduction)를 수행하는 Stream의 collect 메서드는 병렬화에 적합하지않다

- 스레드를 나누는작업을 하는 spliterator 메서드를 재정의하고 결과 스트림의 **병렬화 성능을 강도높게 테스트**하자

- 스트림을 잘못 병렬화하면 성능이 나빠질뿐아니라 예상못한 동작이 발생할수있다.


### 병렬화 필요성


- 병렬화는 오직 성능 최적화를 하기위한 수단이다.

- 병렬화 적용 전/후의 테스트를 통해 병렬화의 가치가 있는지 확인해야한다

- 병렬 스트림 파이프라인은 같은 스레드풀을 사용하므로, 잘못된 파이프라인 하나가있다면 시스템의 다른부분의 성능에까지 악영향을 줄수있다.

- 스트림 파이프라인을 병렬화 할일은 많지않다. 생각보다 병렬화로 효과를 보는경우가 적기때문이다.
  - 조건이 잘갖춰진다면 parallel 메서드 하나로 프로세서 코어수에 비례하는 성능향상을 누릴수있긴하다.

### 무작위 수
- ThreadLocalRandom 보다는 SplittableRandom 을 사용해라
=> 후자는 stream.parellel()을 사용할때 임의 스트림생성을 위한 추가메서드를 제공한다.

- Random은 모든연산을 동기화하기때문에 병렬처리시 최악의 성능을 보인다.


### 요약 
- 병렬화 룰을지키고 성능이 빨라질거라는 확신이 있을때만(꼭 테스트해봐야한다) 스트림 파이프라인 병렬화를 시도해라

- 잘못 병렬화하면 프로그램이 오동작, 성능저하가 일어난다. 

- 병렬화했을때 명확하게 성능이 좋아지고 계산이 정확할때만 사용해라
